<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Series Analysis: Starting from Data</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.5.0/dist/reset.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.5.0/dist/reveal.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.5.0/dist/theme/night.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.5.0/plugin/highlight/monokai.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --accent-blue: #61afef;
            --accent-green: #98c379;
            --accent-yellow: #e5c07b;
            --accent-red: #e06c75;
            --accent-purple: #c678dd;
            --accent-cyan: #56b6c2;
        }
        .reveal h1, .reveal h2, .reveal h3 { text-transform: none; }
        .reveal h1 { font-size: 2.2em; }
        .reveal h2 { font-size: 1.6em; }
        .reveal h3 { font-size: 1.3em; }
        .reveal blockquote {
            font-style: italic;
            background: rgba(255,255,255,0.05);
            padding: 20px 30px;
            border-left: 4px solid #42affa;
            width: 90%;
            margin: 0 auto;
            border-radius: 0 8px 8px 0;
        }
        .reveal .slides section { text-align: left; }
        .reveal ul { display: block; }
        .reveal li { margin: 0.5em 0; font-size: 0.85em; }
        .center-text { text-align: center; }
        .highlight-box {
            background: rgba(66, 175, 250, 0.15);
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid rgba(66, 175, 250, 0.3);
        }
        .warning-box {
            background: rgba(224, 108, 117, 0.15);
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid rgba(224, 108, 117, 0.3);
        }
        .success-box {
            background: rgba(152, 195, 121, 0.15);
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid rgba(152, 195, 121, 0.3);
        }
        .principle-box {
            background: rgba(198, 120, 221, 0.15);
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid rgba(198, 120, 221, 0.3);
        }
        .equation-box {
            background: rgba(255,255,255,0.08);
            padding: 12px 15px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
            font-size: 0.85em;
        }
        .small-text { font-size: 0.75em; }
        .tiny-text { font-size: 0.65em; }
        pre code { font-size: 0.65em !important; line-height: 1.4 !important; }
        .reveal pre { width: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .two-column { display: flex; gap: 30px; align-items: flex-start; }
        .two-column > div { flex: 1; }
        .three-column { display: flex; gap: 20px; }
        .three-column > div { flex: 1; }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }
        .slider-container label {
            min-width: 80px;
            font-size: 0.8em;
        }
        .slider-container input[type="range"] { flex: 1; }
        .slider-container span {
            min-width: 50px;
            font-size: 0.8em;
            color: var(--accent-blue);
        }
        svg text { fill: #abb2bf; font-size: 12px; }
    </style>
</head>
<body>
<div class="reveal">
<div class="slides">

<!-- ============================================ -->
<!-- TITLE SLIDE -->
<!-- ============================================ -->
<section class="center-text" data-background-gradient="linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)">
    <h1>Time Series Analysis</h1>
    <h2>Starting from Data</h2>
    <p class="small-text" style="margin-top: 2em; color: #888;">
        ML for Science and Engineering - Lecture 8
    </p>
</section>

<!-- ============================================ -->
<!-- SECTION 1: STARTING FROM DATA -->
<!-- ============================================ -->
<section>
    <section>
        <h2>What If We Throw Away Differential Equations?</h2>
        <blockquote style="margin-top: 20px;">
            "I'm an engineer. Someone gives me data. Why can't I just use machine learning and forget about ODEs?"
        </blockquote>
        <div class="fragment" style="margin-top: 25px;">
            <p class="small-text">You might be right. Let's start over. You have:</p>
            <div class="equation-box">
                Data: $(u_1, t_1), \; (u_2, t_2), \; \dots, \; (u_n, t_n)$
            </div>
        </div>
        <div class="fragment principle-box small-text" style="margin-top: 15px;">
            <strong>The question:</strong> Can we learn models directly from data, without knowing the physics?
        </div>
    </section>

    <section>
        <h2>First Rule: LOOK at the Data</h2>
        <p class="small-text">Before any model, any algorithm: <strong>visualize</strong>. Then look again.</p>
        <div style="display: flex; justify-content: center; gap: 15px; margin-top: 15px;">
            <!-- Periodicity -->
            <div style="text-align: center;">
                <svg width="120" height="80" style="background: rgba(0,0,0,0.2); border-radius: 6px;">
                    <path d="M 10 40 Q 30 10, 50 40 Q 70 70, 90 40 Q 110 10, 115 40" stroke="#61afef" stroke-width="2" fill="none"/>
                </svg>
                <div class="tiny-text" style="color: #888;">Periodic</div>
            </div>
            <!-- Trend -->
            <div style="text-align: center;">
                <svg width="120" height="80" style="background: rgba(0,0,0,0.2); border-radius: 6px;">
                    <line x1="10" y1="65" x2="110" y2="15" stroke="#98c379" stroke-width="2"/>
                    <circle cx="25" cy="55" r="2" fill="#98c379" opacity="0.6"/>
                    <circle cx="45" cy="52" r="2" fill="#98c379" opacity="0.6"/>
                    <circle cx="60" cy="38" r="2" fill="#98c379" opacity="0.6"/>
                    <circle cx="80" cy="30" r="2" fill="#98c379" opacity="0.6"/>
                    <circle cx="100" cy="22" r="2" fill="#98c379" opacity="0.6"/>
                </svg>
                <div class="tiny-text" style="color: #888;">Trend</div>
            </div>
            <!-- Noisy -->
            <div style="text-align: center;">
                <svg width="120" height="80" style="background: rgba(0,0,0,0.2); border-radius: 6px;">
                    <polyline points="10,40 20,25 30,50 40,35 50,55 60,30 70,45 80,20 90,50 100,38 110,42" stroke="#e06c75" stroke-width="2" fill="none"/>
                </svg>
                <div class="tiny-text" style="color: #888;">Noisy</div>
            </div>
            <!-- Chaotic -->
            <div style="text-align: center;">
                <svg width="120" height="80" style="background: rgba(0,0,0,0.2); border-radius: 6px;">
                    <polyline points="10,40 18,20 26,55 34,15 42,60 50,30 58,65 66,10 74,50 82,25 90,60 98,35 110,45" stroke="#e5c07b" stroke-width="2" fill="none"/>
                </svg>
                <div class="tiny-text" style="color: #888;">Chaotic</div>
            </div>
        </div>
        <div class="fragment highlight-box small-text" style="margin-top: 15px;">
            What you look for: periodicity, trends, noise level, outliers, non-stationarity, correlations.
        </div>
    </section>

    <section>
        <h2>Inductive Bias</h2>
        <p class="small-text">Every model encodes assumptions about the data. The central thread of this lecture:</p>
        <div class="equation-box" style="margin-top: 15px;">
            $f(\mathbf{x}) = \boldsymbol{\theta}^\top \phi(\mathbf{x})$
        </div>
        <p class="small-text" style="margin-top: 10px;">The choice of feature vector $\phi$ <strong>is</strong> the inductive bias.</p>
        <div class="fragment" style="margin-top: 15px;">
            <table class="small-text" style="width: 100%;">
                <tr style="border-bottom: 1px solid #444;"><td style="padding: 6px;">$\phi = [\sin(\omega_k t), \cos(\omega_k t)]$</td><td style="padding: 6px; color: #888;">Fourier decomposition</td></tr>
                <tr style="border-bottom: 1px solid #444;"><td style="padding: 6px;">$\phi = [u_i, u_{i-1}, \dots, u_{i-p}]$</td><td style="padding: 6px; color: #888;">Autoregressive model</td></tr>
                <tr style="border-bottom: 1px solid #444;"><td style="padding: 6px;">$\phi = [1, x, x^2, x^3, \dots]$</td><td style="padding: 6px; color: #888;">Polynomial regression</td></tr>
                <tr><td style="padding: 6px;">$\phi = [1, u, u^2, \sin(u), \dots]$</td><td style="padding: 6px; color: #888;">SINDy (coming soon)</td></tr>
            </table>
        </div>
    </section>
</section>

<!-- ============================================ -->
<!-- SECTION 2: FOURIER / MODAL DECOMPOSITION -->
<!-- ============================================ -->
<section>
    <section>
        <h2>Representation, not Prediction</h2>
        <p class="small-text">Before predicting the future, understand the present.</p>
        <div class="two-column" style="margin-top: 20px;">
            <div>
                <p class="small-text">Your voice is a time series. If someone sings into a microphone, what do you do with the data?</p>
                <div class="fragment highlight-box tiny-text">
                    <strong>Spectrogram:</strong> decompose the signal into frequency components at each point in time.
                </div>
            </div>
            <div class="fragment">
                <p class="small-text">Decompose into interpretable components:</p>
                <div class="equation-box">
                    $u(t) \approx \sum_{k=1}^{K} a_k \phi_k(t)$
                </div>
                <p class="tiny-text" style="color: #888;">Not predicting future values. Just a representation.</p>
            </div>
        </div>
    </section>

    <section>
        <h2>Fourier = Linear Model</h2>
        <p class="small-text">Choose $\phi_k$ to be sines and cosines:</p>
        <div class="equation-box small-text">
            $u(t) \approx \sum_{k=1}^{K} \left[ w_k \sin(2\pi f_k t) + v_k \cos(2\pi f_k t) \right]$
        </div>
        <div class="fragment" style="margin-top: 15px;">
            <p class="small-text">This is just $\boldsymbol{\theta}^\top \phi(t)$ with:</p>
            <div class="equation-box tiny-text">
                $\phi(t) = [\sin(2\pi f_1 t),\; \cos(2\pi f_1 t),\; \dots,\; \sin(2\pi f_K t),\; \cos(2\pi f_K t)]$
            </div>
        </div>
        <div class="fragment" style="margin-top: 10px;">
            <p class="small-text">Design matrix $\Phi$ of size $N \times 2K$, solve least squares:</p>
            <div class="equation-box tiny-text">
                $\hat{\boldsymbol{\theta}} = \arg\min_{\boldsymbol{\theta}} \| \mathbf{u} - \Phi \boldsymbol{\theta} \|^2$
            </div>
        </div>
    </section>

    <section>
        <h2>Interactive: Fourier Superposition</h2>
        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 6px;">
            <span class="tiny-text" style="color: #888;">Target:</span>
            <button class="ref-btn" data-ref="square" style="font-size:0.6em; padding:3px 10px; border:1px solid #61afef; background:rgba(97,175,239,0.15); color:#ccc; border-radius:4px; cursor:pointer;">Square</button>
            <button class="ref-btn" data-ref="triangle" style="font-size:0.6em; padding:3px 10px; border:1px solid #555; background:rgba(255,255,255,0.08); color:#ccc; border-radius:4px; cursor:pointer; opacity:0.5;">Triangle</button>
            <button class="ref-btn" data-ref="sawtooth" style="font-size:0.6em; padding:3px 10px; border:1px solid #555; background:rgba(255,255,255,0.08); color:#ccc; border-radius:4px; cursor:pointer; opacity:0.5;">Sawtooth</button>
            <span style="flex:1;"></span>
            <button id="fourier-reveal" style="font-size:0.6em; padding:3px 10px; border:1px solid #555; background:rgba(152,195,121,0.15); color:#98c379; border-radius:4px; cursor:pointer;">Show Answer</button>
            <button id="fourier-reset" style="font-size:0.6em; padding:3px 10px; border:1px solid #555; background:rgba(224,108,117,0.15); color:#e06c75; border-radius:4px; cursor:pointer;">Reset</button>
        </div>
        <div id="fourier-plot" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px;"></div>
        <p class="tiny-text center-text" style="color: #888; margin-top: 4px;">
            <span style="color: #888;">- - -</span> target &emsp;
            <span style="color: #e5c07b;">&#9473;</span> your approximation &emsp;
            | &emsp; Drag the frequency bars to match the target signal
        </p>
    </section>

    <section>
        <h2>Short-Time Fourier Transform</h2>
        <p class="small-text">What if the frequency content changes over time? Apply Fourier in windows:</p>
        <div class="equation-box tiny-text" style="margin-top: 10px;">
            $S(t, f) = \left| \int u(\tau)\, w(\tau - t)\, e^{-2\pi i f \tau}\, d\tau \right|^2$
        </div>
        <div style="display: flex; justify-content: center; margin-top: 15px;">
            <svg width="600" height="200" style="background: rgba(0,0,0,0.2); border-radius: 8px;">
                <!-- Top: chirp signal -->
                <text x="10" y="15" fill="#888" font-size="11">Signal (chirp):</text>
                <polyline id="chirp-signal" fill="none" stroke="#61afef" stroke-width="1.5"/>
                <!-- Bottom: spectrogram approximation -->
                <text x="10" y="85" fill="#888" font-size="11">Spectrogram:</text>
                <g id="spectrogram-blocks"></g>
                <!-- Axes -->
                <text x="300" y="198" fill="#888" font-size="11" text-anchor="middle">time</text>
                <text x="588" y="145" fill="#888" font-size="10" text-anchor="end">freq</text>
            </svg>
        </div>
        <script>
        (function() {
            // Draw chirp signal
            let pts = '';
            for (let i = 0; i < 560; i++) {
                const t = i / 560 * 6;
                const freq = 1 + t * 2;
                const y = 45 + Math.sin(2 * Math.PI * freq * t * 0.3) * 20;
                pts += `${20 + i},${y} `;
            }
            document.getElementById('chirp-signal').setAttribute('points', pts.trim());

            // Draw spectrogram blocks
            const g = document.getElementById('spectrogram-blocks');
            const cols = 40, rows = 10;
            for (let c = 0; c < cols; c++) {
                const t = c / cols * 6;
                const peakFreq = 1 + t * 2;
                for (let r = 0; r < rows; r++) {
                    const f = (r + 1);
                    const dist = Math.abs(f - peakFreq);
                    const intensity = Math.max(0, 1 - dist * 0.4);
                    if (intensity > 0.05) {
                        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        rect.setAttribute('x', 20 + c * 14);
                        rect.setAttribute('y', 170 - r * 10);
                        rect.setAttribute('width', 13);
                        rect.setAttribute('height', 9);
                        rect.setAttribute('fill', `rgba(97, 175, 239, ${intensity})`);
                        rect.setAttribute('rx', '1');
                        g.appendChild(rect);
                    }
                }
            }
        })();
        </script>
        <p class="fragment tiny-text center-text" style="color: #888; margin-top: 8px;">
            Voice, music, EEG, seismic data: frequency content evolves in time.
        </p>
    </section>

    <section>
        <h2>General Modal Decomposition</h2>
        <p class="small-text">Sines and cosines are one choice. What others exist?</p>
        <table class="small-text" style="width: 100%; margin-top: 15px;">
            <tr style="border-bottom: 1px solid #555;">
                <td style="padding: 6px;"><strong>Basis</strong></td>
                <td style="padding: 6px;"><strong>$\phi_k(t)$</strong></td>
                <td style="padding: 6px; color: #888;"><strong>Use case</strong></td>
            </tr>
            <tr style="border-bottom: 1px solid #333;">
                <td style="padding: 6px;">Fourier</td>
                <td style="padding: 6px;">$\sin(k\omega t),\;\cos(k\omega t)$</td>
                <td style="padding: 6px; color: #888;">Periodic signals</td>
            </tr>
            <tr style="border-bottom: 1px solid #333;">
                <td style="padding: 6px;">Polynomials</td>
                <td style="padding: 6px;">$1,\; t,\; t^2,\; t^3,\; \dots$</td>
                <td style="padding: 6px; color: #888;">Smooth trends</td>
            </tr>
            <tr style="border-bottom: 1px solid #333;">
                <td style="padding: 6px;">Wavelets</td>
                <td style="padding: 6px;">localized in time and frequency</td>
                <td style="padding: 6px; color: #888;">Transients, edges</td>
            </tr>
            <tr>
                <td style="padding: 6px;">Legendre</td>
                <td style="padding: 6px;">$P_k(t)$</td>
                <td style="padding: 6px; color: #888;">Orthogonal on $[-1,1]$</td>
            </tr>
        </table>
        <div class="fragment principle-box small-text" style="margin-top: 15px;">
            Key property: <strong>orthogonality</strong> $\langle \phi_i, \phi_j \rangle = \delta_{ij}$ ensures the basis spans the space efficiently. The choice of basis IS your inductive bias.
        </div>
    </section>

    <section>
        <h2>Physics of Harmonics</h2>
        <p class="small-text">Where do sines and cosines come from in physics?</p>
        <div class="equation-box small-text" style="margin-top: 10px;">
            Wave equation: $\quad\displaystyle\frac{\partial^2 u}{\partial t^2} = c^2 \frac{\partial^2 u}{\partial x^2}$
        </div>
        <p class="small-text fragment" style="margin-top: 10px;">Fixed boundary conditions on a string $\rightarrow$ only discrete frequencies survive:</p>
        <div class="fragment" style="display: flex; justify-content: center; margin-top: 10px;">
            <svg width="500" height="130" style="background: rgba(0,0,0,0.2); border-radius: 8px;">
                <!-- n=1 -->
                <circle cx="20" cy="35" r="4" fill="#888"/>
                <circle cx="180" cy="35" r="4" fill="#888"/>
                <path d="M 20 35 Q 100 -5, 180 35" stroke="#61afef" stroke-width="2" fill="none"/>
                <text x="100" y="60" fill="#61afef" font-size="12" text-anchor="middle">n = 1</text>
                <!-- n=2 -->
                <circle cx="200" cy="35" r="4" fill="#888"/>
                <circle cx="360" cy="35" r="4" fill="#888"/>
                <path d="M 200 35 Q 240 5, 280 35 Q 320 65, 360 35" stroke="#98c379" stroke-width="2" fill="none"/>
                <text x="280" y="60" fill="#98c379" font-size="12" text-anchor="middle">n = 2</text>
                <!-- n=3 -->
                <circle cx="380" cy="35" r="4" fill="#888"/>
                <circle cx="490" cy="35" r="4" fill="#888"/>
                <path d="M 380 35 Q 398 15, 416 35 Q 434 55, 453 35 Q 471 15, 490 35" stroke="#e5c07b" stroke-width="2" fill="none"/>
                <text x="435" y="60" fill="#e5c07b" font-size="12" text-anchor="middle">n = 3</text>
                <!-- Caption -->
                <text x="250" y="90" fill="#888" font-size="11" text-anchor="middle">Standing waves: $f_n = n \cdot f_1$ (harmonics)</text>
                <text x="250" y="110" fill="#888" font-size="11" text-anchor="middle">Linear PDE → superposition → sum of modes</text>
            </svg>
        </div>
        <div class="fragment success-box tiny-text" style="margin-top: 10px;">
            Fourier decomposition is natural because the wave equation is linear: each mode satisfies the equation, so their sum does too.
        </div>
    </section>
</section>

<!-- ============================================ -->
<!-- SECTION 3: AUTOREGRESSIVE MODELS -->
<!-- ============================================ -->
<section>
    <section>
        <h2>From Representation to Prediction</h2>
        <p class="small-text">Fourier tells us what's in the signal. But can we <strong>predict the next value</strong>?</p>
        <div class="equation-box" style="margin-top: 20px;">
            $u_{i+1} = f(u_i, u_{i-1}, \dots, u_{i-p+1})$
        </div>
        <div class="fragment" style="margin-top: 15px;">
            <p class="small-text">The feature vector is now:</p>
            <div class="equation-box">
                $\phi = [u_i, \; u_{i-1}, \; \dots, \; u_{i-p+1}, \; 1]$
            </div>
        </div>
        <div class="fragment principle-box small-text" style="margin-top: 15px;">
            Still $\boldsymbol{\theta}^\top \phi(\mathbf{u})$. Still linear regression!
        </div>
    </section>

    <section>
        <h2>AR(p) Model</h2>
        <p class="small-text">The autoregressive model of order $p$:</p>
        <div class="equation-box" style="margin-top: 15px;">
            $u_i = w_1 u_{i-1} + w_2 u_{i-2} + \dots + w_p u_{i-p} + w_0$
        </div>
        <div class="fragment" style="margin-top: 15px;">
            <p class="small-text">In matrix form: $\;\mathbf{u} = \Phi \mathbf{w}$</p>
            <div class="equation-box tiny-text">
                $\begin{bmatrix} u_p \\ u_{p+1} \\ \vdots \\ u_n \end{bmatrix} = \begin{bmatrix} u_{p-1} & u_{p-2} & \cdots & u_0 & 1 \\ u_p & u_{p-1} & \cdots & u_1 & 1 \\ \vdots & & \ddots & & \vdots \\ u_{n-1} & u_{n-2} & \cdots & u_{n-p} & 1 \end{bmatrix} \begin{bmatrix} w_1 \\ w_2 \\ \vdots \\ w_p \\ w_0 \end{bmatrix}$
            </div>
        </div>
    </section>

    <section>
        <h2>In-Class Exercise: AR(2) on a Sine Wave</h2>
        <p class="small-text">Given $u_i = \sin(\omega \cdot i)$ for $i = 0, \dots, 199$ with $\omega = 0.3$:</p>
        <div class="two-column" style="margin-top: 10px;">
            <div>
                <ol class="tiny-text">
                    <li>Build design matrix: columns $[u_{i-1},\; u_{i-2},\; 1]$</li>
                    <li>Target vector: $u_i$ for $i = 2, \dots, N-1$</li>
                    <li>Solve via least squares</li>
                </ol>
            </div>
            <div>
                <pre><code class="python">import numpy as np

N, omega = 200, 0.3
u = np.sin(omega * np.arange(N))

# Design matrix
Phi = np.column_stack([
    u[1:-1],     # u_{i-1}
    u[:-2],      # u_{i-2}
    np.ones(N-2) # bias
])
y = u[2:]        # target

# Least squares
w = np.linalg.lstsq(Phi, y, rcond=None)[0]
print(f"w1={w[0]:.4f}, w2={w[1]:.4f}")</code></pre>
            </div>
        </div>
    </section>

    <section>
        <h2>AR(2): Analytical Result</h2>
        <p class="small-text">Trigonometric identity:</p>
        <div class="equation-box small-text" style="margin-top: 15px;">
            $\sin(\omega i) = 2\cos(\omega)\sin(\omega(i-1)) - \sin(\omega(i-2))$
        </div>
        <div class="fragment" style="margin-top: 20px;">
            <p class="small-text">Therefore:</p>
            <div class="equation-box">
                $w_1 = 2\cos(\omega), \quad w_2 = -1, \quad w_0 = 0$
            </div>
        </div>
        <div class="fragment success-box small-text" style="margin-top: 15px;">
            Recover frequency: $\;\omega = \arccos(w_1 / 2)$. AR learns the frequency without us telling it!
        </div>
    </section>

    <section>
        <h2>Interactive: AR(2) Prediction</h2>
        <div id="ar2-plot" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px;"></div>
        <div style="display: flex; gap: 20px; align-items: center; margin-top: 10px;">
            <div class="slider-container" style="flex: 1;">
                <label class="tiny-text">$\omega$:</label>
                <input type="range" id="omega" min="0.1" max="0.8" step="0.01" value="0.3" style="accent-color: #61afef;">
                <span id="omega-val" class="tiny-text">0.30</span>
            </div>
            <div id="ar2-params" class="tiny-text" style="color: #888;"></div>
        </div>
        <p class="tiny-text center-text" style="color: #888; margin-top: 5px;">
            <span style="color: #61afef;">&#9632;</span> true &emsp; <span style="color: #e06c75;">- - -</span> AR(2) prediction
        </p>
    </section>

    <section>
        <h2>ARIMA and Extensions</h2>
        <p class="small-text">ARIMA = AR + Integration + Moving Average</p>
        <div class="two-column" style="margin-top: 15px;">
            <div>
                <div class="highlight-box tiny-text">
                    <strong>Differencing</strong> (the I in ARIMA):<br>
                    $\Delta u_i = u_i - u_{i-1}$<br>
                    Removes trends from the data.
                </div>
            </div>
            <div>
                <div class="highlight-box tiny-text">
                    <strong>Moving Average</strong> (MA):<br>
                    $u_i = \dots + \theta_1 \varepsilon_{i-1} + \theta_2 \varepsilon_{i-2}$<br>
                    Models dependence on past errors.
                </div>
            </div>
        </div>
        <div class="fragment tiny-text" style="margin-top: 15px; color: #888;">
            ARIMA is a workhorse of classical time series analysis: econometrics, demand forecasting, resource planning.
        </div>
    </section>

    <section>
        <h2>Nonlinear AR Extensions</h2>
        <p class="small-text">What if the relationship is nonlinear?</p>
        <p class="small-text" style="margin-top: 10px;">Replace $\phi = [u_i, u_{i-1}]$ with polynomial features:</p>
        <div class="equation-box small-text" style="margin-top: 10px;">
            $\phi = [u_i, \; u_{i-1}, \; u_i^2, \; u_i u_{i-1}, \; u_{i-1}^2, \; \dots]$
        </div>
        <div class="fragment" style="margin-top: 15px;">
            <p class="small-text">Still $\boldsymbol{\theta}^\top \phi$. Still linear regression! (Linear in $\theta$, nonlinear in $u$.)</p>
        </div>
        <div class="fragment warning-box tiny-text" style="margin-top: 10px;">
            More features = more parameters = need more data (curse of dimensionality).
        </div>
        <div class="fragment tiny-text" style="margin-top: 10px; color: var(--accent-purple);">
            This idea of a "library of candidate functions" will return soon...
        </div>
    </section>
</section>

<!-- ============================================ -->
<!-- SECTION 4: BRIDGE TO ODES -->
<!-- ============================================ -->
<section>
    <section>
        <h2>From Discrete Maps to ODEs</h2>
        <p class="small-text">Start with a next-step model:</p>
        <div class="equation-box" style="margin-top: 15px;">
            $u_{i+1} = f(u_i)$
        </div>
        <div class="fragment" style="margin-top: 15px;">
            <p class="small-text">Rewrite as:</p>
            <div class="equation-box">
                $u_{i+1} = u_i + \underbrace{[f(u_i) - u_i]}_{g(u_i) \cdot \Delta t}$
            </div>
        </div>
        <div class="fragment" style="margin-top: 15px;">
            <p class="small-text">Recognize: $\;u_{i+1} - u_i \approx \dot{u} \cdot \Delta t$, so:</p>
            <div class="equation-box">
                $u_{i+1} = u_i + g(u_i)\,\Delta t$
            </div>
        </div>
        <div class="fragment principle-box small-text" style="margin-top: 10px;">
            This is the <strong>forward Euler method</strong>. Discrete AR models are discrete-time dynamical systems. ODEs are their continuous cousins.
        </div>
    </section>

    <section>
        <h2>$\Delta t$ Matters</h2>
        <div class="two-column" style="margin-top: 15px;">
            <div>
                <div class="success-box tiny-text" style="text-align: center;">
                    <strong>Uniform spacing</strong><br><br>
                    <svg width="200" height="40" style="margin: 0 auto; display: block;">
                        <line x1="10" y1="20" x2="190" y2="20" stroke="#666" stroke-width="1"/>
                        <circle cx="30" cy="20" r="4" fill="#98c379"/>
                        <circle cx="70" cy="20" r="4" fill="#98c379"/>
                        <circle cx="110" cy="20" r="4" fill="#98c379"/>
                        <circle cx="150" cy="20" r="4" fill="#98c379"/>
                    </svg>
                    Standard AR works fine
                </div>
            </div>
            <div>
                <div class="warning-box tiny-text" style="text-align: center;">
                    <strong>Non-uniform spacing</strong><br><br>
                    <svg width="200" height="40" style="margin: 0 auto; display: block;">
                        <line x1="10" y1="20" x2="190" y2="20" stroke="#666" stroke-width="1"/>
                        <circle cx="20" cy="20" r="4" fill="#e06c75"/>
                        <circle cx="50" cy="20" r="4" fill="#e06c75"/>
                        <circle cx="100" cy="20" r="4" fill="#e06c75"/>
                        <circle cx="170" cy="20" r="4" fill="#e06c75"/>
                    </svg>
                    AR coefficients change with $\Delta t$!
                </div>
            </div>
        </div>
        <div class="fragment highlight-box small-text" style="margin-top: 20px;">
            The ODE $\dot{u} = g(u)$ is independent of sampling rate. This is one reason to prefer differential equation models.
        </div>
    </section>

    <section>
        <h2>Multi-Step vs Local</h2>
        <p class="small-text">AR(p) with $p > 1$: $u_{i+1}$ depends on $u_i, u_{i-1}, \dots$ (non-local in time)</p>
        <p class="small-text" style="margin-top: 10px;">ODE: $\dot{u} = g(u)$ depends only on current state (local)</p>
        <div class="fragment" style="margin-top: 20px;">
            <p class="small-text">But higher-order effects can be captured:</p>
            <div class="equation-box small-text">
                AR(2) for sine: $\;u_{i+1} = 2\cos(\omega)\,u_i - u_{i-1}$ $\quad\longleftrightarrow\quad$ ODE: $\;\ddot{u} + \omega^2 u = 0$
            </div>
        </div>
        <div class="fragment principle-box small-text" style="margin-top: 15px;">
            Autoregressive models and differential equations are two views of the same underlying dynamics.
        </div>
    </section>
</section>

<!-- ============================================ -->
<!-- SECTION 5: LOGISTIC MAP -->
<!-- ============================================ -->
<section>
    <section>
        <h2>The Logistic Map</h2>
        <p class="small-text">Population modeling: how does a population grow with limited resources?</p>
        <div class="two-column" style="margin-top: 15px;">
            <div>
                <p class="tiny-text">Continuous (ODE):</p>
                <div class="equation-box tiny-text">
                    $\dot{x} = rx(1 - x)$
                </div>
                <p class="tiny-text" style="margin-top: 10px;">Discrete (map):</p>
                <div class="equation-box">
                    $x_{n+1} = r \cdot x_n(1 - x_n)$
                </div>
            </div>
            <div class="fragment">
                <p class="tiny-text">Robert May (1976) showed this simple equation produces remarkably complex behavior:</p>
                <ul class="tiny-text">
                    <li>$r < 3$: stable fixed point</li>
                    <li>$r \approx 3.5$: period doubling</li>
                    <li>$r > 3.57$: chaos</li>
                </ul>
            </div>
        </div>
    </section>

    <section>
        <h2>Interactive: Logistic Map</h2>
        <div style="display: flex; justify-content: center;">
            <svg id="logistic-svg" width="700" height="280" style="background: rgba(0,0,0,0.3); border-radius: 8px;"></svg>
        </div>
        <div style="display: flex; gap: 20px; margin-top: 10px;">
            <div class="slider-container" style="flex: 1;">
                <label class="tiny-text">$r$:</label>
                <input type="range" id="logistic-r" min="1.0" max="4.0" step="0.01" value="2.5" style="accent-color: #e5c07b;">
                <span id="logistic-r-val" class="tiny-text" style="color: #e5c07b;">2.50</span>
            </div>
            <div class="slider-container" style="flex: 1;">
                <label class="tiny-text">$x_0$:</label>
                <input type="range" id="logistic-x0" min="0.01" max="0.99" step="0.01" value="0.2" style="accent-color: #61afef;">
                <span id="logistic-x0-val" class="tiny-text" style="color: #61afef;">0.20</span>
            </div>
        </div>
        <script>
        (function() {
            const svg = document.getElementById('logistic-svg');
            const ns = 'http://www.w3.org/2000/svg';
            const W = 700, H = 280;
            const margin = {top: 15, right: 20, bottom: 25, left: 45};
            const pw = W - margin.left - margin.right;
            const ph = H - margin.top - margin.bottom;

            // Axes
            const axX = document.createElementNS(ns, 'line');
            axX.setAttribute('x1', margin.left); axX.setAttribute('y1', H - margin.bottom);
            axX.setAttribute('x2', W - margin.right); axX.setAttribute('y2', H - margin.bottom);
            axX.setAttribute('stroke', '#555'); axX.setAttribute('stroke-width', '1');
            svg.appendChild(axX);

            const axY = document.createElementNS(ns, 'line');
            axY.setAttribute('x1', margin.left); axY.setAttribute('y1', margin.top);
            axY.setAttribute('x2', margin.left); axY.setAttribute('y2', H - margin.bottom);
            axY.setAttribute('stroke', '#555'); axY.setAttribute('stroke-width', '1');
            svg.appendChild(axY);

            // Axis labels
            const labN = document.createElementNS(ns, 'foreignObject');
            labN.setAttribute('x', W/2 - 10); labN.setAttribute('y', H - 20);
            labN.setAttribute('width', 30); labN.setAttribute('height', 20);
            labN.innerHTML = '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size:12px;color:#888;">$n$</div>';
            svg.appendChild(labN);

            const labX = document.createElementNS(ns, 'foreignObject');
            labX.setAttribute('x', 5); labX.setAttribute('y', margin.top);
            labX.setAttribute('width', 40); labX.setAttribute('height', 20);
            labX.innerHTML = '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size:12px;color:#888;">$x_n$</div>';
            svg.appendChild(labX);

            // Y-axis ticks
            [0, 0.5, 1.0].forEach(v => {
                const y = H - margin.bottom - v * ph;
                const tick = document.createElementNS(ns, 'line');
                tick.setAttribute('x1', margin.left - 4); tick.setAttribute('y1', y);
                tick.setAttribute('x2', margin.left); tick.setAttribute('y2', y);
                tick.setAttribute('stroke', '#555');
                svg.appendChild(tick);
                const label = document.createElementNS(ns, 'text');
                label.setAttribute('x', margin.left - 8); label.setAttribute('y', y + 4);
                label.setAttribute('text-anchor', 'end'); label.setAttribute('font-size', '10');
                label.textContent = v.toFixed(1);
                svg.appendChild(label);
            });

            // Trace and dots
            const traceLine = document.createElementNS(ns, 'polyline');
            traceLine.setAttribute('fill', 'none');
            traceLine.setAttribute('stroke', '#e5c07b');
            traceLine.setAttribute('stroke-width', '1.5');
            traceLine.setAttribute('stroke-linejoin', 'round');
            svg.appendChild(traceLine);

            const dotsGroup = document.createElementNS(ns, 'g');
            svg.appendChild(dotsGroup);

            const Niter = 80;

            function update() {
                const r = parseFloat(document.getElementById('logistic-r').value);
                const x0 = parseFloat(document.getElementById('logistic-x0').value);
                document.getElementById('logistic-r-val').textContent = r.toFixed(2);
                document.getElementById('logistic-x0-val').textContent = x0.toFixed(2);

                const xs = [x0];
                for (let i = 0; i < Niter; i++) {
                    const xn = xs[xs.length - 1];
                    xs.push(r * xn * (1 - xn));
                }

                let pts = '';
                dotsGroup.innerHTML = '';
                for (let i = 0; i <= Niter; i++) {
                    const px = margin.left + (i / Niter) * pw;
                    const py = H - margin.bottom - Math.max(0, Math.min(1, xs[i])) * ph;
                    pts += `${px.toFixed(1)},${py.toFixed(1)} `;
                    const dot = document.createElementNS(ns, 'circle');
                    dot.setAttribute('cx', px.toFixed(1));
                    dot.setAttribute('cy', py.toFixed(1));
                    dot.setAttribute('r', '2.5');
                    dot.setAttribute('fill', '#e5c07b');
                    dot.setAttribute('opacity', '0.8');
                    dotsGroup.appendChild(dot);
                }
                traceLine.setAttribute('points', pts.trim());
            }

            document.getElementById('logistic-r').addEventListener('input', update);
            document.getElementById('logistic-x0').addEventListener('input', update);
            update();
        })();
        </script>
    </section>

    <section>
        <h2>Given Data, Find the Map</h2>
        <p class="small-text">Suppose you observe $x_0, x_1, \dots, x_N$ but don't know the governing equation.</p>
        <p class="small-text" style="margin-top: 10px;">Since $rx(1-x) = rx - rx^2$, try features $\phi(x) = [1, x, x^2]$:</p>
        <div class="equation-box small-text" style="margin-top: 10px;">
            $\begin{bmatrix} 1 & x_0 & x_0^2 \\ 1 & x_1 & x_1^2 \\ \vdots & \vdots & \vdots \\ 1 & x_{N-1} & x_{N-1}^2 \end{bmatrix} \begin{bmatrix} \theta_0 \\ \theta_1 \\ \theta_2 \end{bmatrix} = \begin{bmatrix} x_1 \\ x_2 \\ \vdots \\ x_N \end{bmatrix}$
        </div>
        <div class="fragment success-box small-text" style="margin-top: 15px;">
            Should recover $\theta_0 = 0$, $\theta_1 = r$, $\theta_2 = -r$. We discover the governing equation from data alone!
        </div>
    </section>

    <section>
        <h2>Homework Preview</h2>
        <p class="small-text">You will:</p>
        <ul class="small-text">
            <li>Generate logistic map data with noise</li>
            <li>Build the design matrix and recover $r$</li>
            <li>Study how noise level affects parameter recovery</li>
        </ul>
        <div class="fragment" style="margin-top: 20px;">
            <p class="small-text">Harder question: what if you don't know the right features?</p>
            <p class="small-text" style="color: #888;">Use a richer library: $\phi = [1, x, x^2, x^3, \sin(x), \dots]$</p>
            <p class="small-text" style="color: var(--accent-purple);">Most entries of $\theta$ should be zero. This is the idea behind <strong>sparse regression</strong>.</p>
        </div>
    </section>
</section>

<!-- ============================================ -->
<!-- SECTION 6: SINDY MOTIVATION -->
<!-- ============================================ -->
<section>
    <section>
        <h2>Learning $\dot{u} = f(u)$</h2>
        <p class="small-text">So far: learned discrete maps $u_{i+1} = f(u_i)$.</p>
        <p class="small-text" style="margin-top: 10px;">Alternative: learn the continuous ODE directly.</p>
        <div class="equation-box" style="margin-top: 15px;">
            $\dot{u} = f(u)$
        </div>
        <div class="fragment" style="margin-top: 15px;">
            <p class="small-text">How to get $\dot{u}$ from data? Numerical differentiation:</p>
            <div class="two-column tiny-text">
                <div class="equation-box">
                    Forward: $\;\dot{u}(t_i) \approx \dfrac{u_{i+1} - u_i}{\Delta t}$
                </div>
                <div class="equation-box">
                    Centered: $\;\dot{u}(t_i) \approx \dfrac{u_{i+1} - u_{i-1}}{2\Delta t}$
                </div>
            </div>
        </div>
        <div class="fragment warning-box tiny-text" style="margin-top: 10px;">
            Numerical differentiation amplifies noise. Smoothing or regularization is often needed.
        </div>
    </section>

    <section>
        <h2>The Library Idea</h2>
        <p class="small-text">What is $f$? We don't know. But we can guess candidate functions:</p>
        <div class="equation-box small-text" style="margin-top: 10px;">
            Library: $\;\phi(u) = [1, \; u, \; u^2, \; u^3, \; \sin(u), \; \cos(u), \; \dots]$
        </div>
        <div class="fragment" style="margin-top: 15px;">
            <p class="small-text">Build the design matrix and solve:</p>
            <div class="equation-box small-text">
                $\dot{\mathbf{u}} = \Phi(\mathbf{u}) \, \boldsymbol{\theta}$
            </div>
        </div>
        <div class="fragment" style="margin-top: 15px;">
            <!-- Pipeline diagram -->
            <div style="display: flex; justify-content: center; align-items: center; gap: 10px;" class="tiny-text">
                <div class="highlight-box" style="padding: 8px 12px; margin: 0;">Data<br>$\{u_i, t_i\}$</div>
                <span style="color: #888;">$\rightarrow$</span>
                <div class="warning-box" style="padding: 8px 12px; margin: 0;">Differentiate<br>$\dot{u}_i$</div>
                <span style="color: #888;">$\rightarrow$</span>
                <div class="highlight-box" style="padding: 8px 12px; margin: 0;">Build library<br>$\Phi(u)$</div>
                <span style="color: #888;">$\rightarrow$</span>
                <div class="principle-box" style="padding: 8px 12px; margin: 0;">Sparse<br>regression</div>
                <span style="color: #888;">$\rightarrow$</span>
                <div class="success-box" style="padding: 8px 12px; margin: 0;">Discovered<br>equation</div>
            </div>
        </div>
        <p class="fragment tiny-text" style="margin-top: 10px; color: #888;">Most candidates are wrong. We want $\boldsymbol{\theta}$ to be <strong>sparse</strong>. This is the <strong>SINDy</strong> framework.</p>
    </section>

    <section>
        <h2>Looking Ahead</h2>
        <p class="small-text">Next lectures:</p>
        <ul class="small-text">
            <li><strong>Lecture 9:</strong> System Identification: fitting coefficients for known equation structures</li>
            <li><strong>Lecture 10:</strong> SINDy: discovering the equation structure itself from data</li>
        </ul>
        <div class="highlight-box small-text" style="margin-top: 20px;">
            <strong>Read:</strong> Brunton, Proctor, Kutz. "Discovering governing equations from data by sparse identification of nonlinear dynamical systems." (2016)
        </div>
        <div class="fragment principle-box small-text" style="margin-top: 15px;">
            The central thread: the design matrix $\Phi$ and feature vector $\phi$ connect Fourier, AR, logistic maps, and SINDy. <strong>It's all linear regression with the right features.</strong>
        </div>
    </section>
</section>

<!-- ============================================ -->
<!-- SUMMARY -->
<!-- ============================================ -->
<section data-background-gradient="linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)">
    <h2>Summary</h2>
    <table class="small-text" style="width: 100%; margin-top: 15px;">
        <tr style="border-bottom: 2px solid #555;">
            <td style="padding: 8px;"><strong>Method</strong></td>
            <td style="padding: 8px;"><strong>Feature vector $\phi$</strong></td>
            <td style="padding: 8px;"><strong>Goal</strong></td>
        </tr>
        <tr style="border-bottom: 1px solid #333;">
            <td style="padding: 8px;">Fourier</td>
            <td style="padding: 8px;">$[\sin(f_k t), \cos(f_k t)]$</td>
            <td style="padding: 8px; color: #888;">Representation</td>
        </tr>
        <tr style="border-bottom: 1px solid #333;">
            <td style="padding: 8px;">AR(p)</td>
            <td style="padding: 8px;">$[u_i, u_{i-1}, \dots]$</td>
            <td style="padding: 8px; color: #888;">Prediction</td>
        </tr>
        <tr style="border-bottom: 1px solid #333;">
            <td style="padding: 8px;">Logistic Map</td>
            <td style="padding: 8px;">$[1, x, x^2]$</td>
            <td style="padding: 8px; color: #888;">Discover map</td>
        </tr>
        <tr>
            <td style="padding: 8px;">SINDy</td>
            <td style="padding: 8px;">$[1, u, u^2, \sin(u), \dots]$</td>
            <td style="padding: 8px; color: #888;">Discover ODE</td>
        </tr>
    </table>
    <div class="principle-box small-text" style="margin-top: 25px;">
        Everything is $\boldsymbol{\theta}^\top \phi$. The art is choosing $\phi$.
    </div>
</section>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/reveal.js@4.5.0/dist/reveal.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4.5.0/plugin/math/math.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4.5.0/plugin/highlight/highlight.js"></script>
<script>
Reveal.initialize({
    hash: true,
    slideNumber: true,
    transition: 'slide',
    width: 1100,
    height: 650,
    margin: 0.15,
    plugins: [ RevealMath.KaTeX, RevealHighlight ]
});

// ============ D3 INTERACTIVE PLOTS ============

Reveal.on('slidechanged', event => {
    if (event.currentSlide.querySelector('#fourier-plot') && !document.querySelector('#fourier-plot svg')) {
        initFourierPlot();
    }
    if (event.currentSlide.querySelector('#ar2-plot') && !document.querySelector('#ar2-plot svg')) {
        initAR2Plot();
    }
});

function initFourierPlot() {
    const container = d3.select('#fourier-plot');
    container.selectAll('*').remove();

    const W = 900, H = 350;
    const svg = container.append('svg').attr('width', W).attr('height', H);

    // === TIME DOMAIN (left panel) ===
    const TM = {l:45, r:10, t:25, b:30};
    const TW = 480;
    const tpw = TW - TM.l - TM.r, tph = H - TM.t - TM.b;
    const gT = svg.append('g').attr('transform', `translate(${TM.l},${TM.t})`);

    svg.append('defs').append('clipPath').attr('id','fourier-clip')
       .append('rect').attr('width', tpw).attr('height', tph);

    const xT = d3.scaleLinear().domain([0, 4*Math.PI]).range([0, tpw]);
    const yT = d3.scaleLinear().domain([-2, 2]).range([tph, 0]);

    gT.append('g').attr('class','axis').attr('transform',`translate(0,${tph})`)
      .call(d3.axisBottom(xT).ticks(6).tickFormat(d => (d/Math.PI).toFixed(0)+'π'));
    gT.append('g').attr('class','axis').call(d3.axisLeft(yT).ticks(5));
    gT.append('line').attr('x1',0).attr('x2',tpw)
      .attr('y1',yT(0)).attr('y2',yT(0)).attr('stroke','#444');
    gT.append('text').attr('x',tpw/2).attr('y',-8)
      .attr('text-anchor','middle').attr('fill','#888').attr('font-size','11px')
      .text('Time Domain — u(t)');

    const gTclip = gT.append('g').attr('clip-path','url(#fourier-clip)');
    const refPath = gTclip.append('path').attr('fill','none')
      .attr('stroke','#888').attr('stroke-width',2).attr('stroke-dasharray','6,3');
    const approxPath = gTclip.append('path').attr('fill','none')
      .attr('stroke','#e5c07b').attr('stroke-width',2.5);
    const lineFn = d3.line().x(d=>xT(d.t)).y(d=>yT(d.v));

    // === FREQUENCY DOMAIN (right panel) ===
    const FM = {l:40, r:10, t:25, b:30};
    const fxStart = TW + 35;
    const FW = W - fxStart;
    const fpw = FW - FM.l - FM.r, fph = H - FM.t - FM.b;
    const gF = svg.append('g').attr('transform', `translate(${fxStart+FM.l},${FM.t})`);

    const nH = 8;
    const amps = new Array(nH).fill(0);

    const refs = {
        square:   k => k%2===1 ? 4/(Math.PI*k) : 0,
        triangle: k => k%2===1 ? 8/(Math.PI*Math.PI*k*k)*Math.pow(-1,(k-1)/2) : 0,
        sawtooth: k => -2/(Math.PI*k)*Math.pow(-1,k)
    };
    let curRef = 'square';

    const fLabels = d3.range(1,nH+1).map(k => k===1 ? 'ω' : k+'ω');
    const xF = d3.scaleBand().domain(d3.range(nH)).range([0,fpw]).padding(0.25);
    const yF = d3.scaleLinear().domain([-1.5,1.5]).range([fph,0]);

    gF.append('g').attr('class','axis').attr('transform',`translate(0,${fph})`)
      .call(d3.axisBottom(xF).tickFormat(i => fLabels[i]));
    gF.append('g').attr('class','axis').call(d3.axisLeft(yF).ticks(5));
    gF.append('line').attr('x1',0).attr('x2',fpw)
      .attr('y1',yF(0)).attr('y2',yF(0)).attr('stroke','#555');
    gF.append('text').attr('x',fpw/2).attr('y',-8)
      .attr('text-anchor','middle').attr('fill','#888').attr('font-size','11px')
      .text('Frequency Components — aₖ');

    // Target bar outlines (dashed)
    const refBars = gF.selectAll('.rb').data(d3.range(nH)).enter()
      .append('rect').attr('x', i=>xF(i)).attr('width', xF.bandwidth())
      .attr('fill','none').attr('stroke','#888').attr('stroke-width',1.5)
      .attr('stroke-dasharray','4,2').attr('rx',2);

    // User amplitude bars
    const bars = gF.selectAll('.ub').data(d3.range(nH)).enter()
      .append('rect').attr('x', i=>xF(i)).attr('width', xF.bandwidth())
      .attr('fill','#61afef').attr('opacity',0.7).attr('rx',2)
      .attr('y', yF(0)).attr('height',0);

    // Drag handles (circles at bar tops)
    const handles = gF.selectAll('.hd').data(d3.range(nH)).enter()
      .append('circle').attr('cx', i=>xF(i)+xF.bandwidth()/2)
      .attr('cy', yF(0)).attr('r',5)
      .attr('fill','#61afef').attr('stroke','#fff').attr('stroke-width',1.5)
      .style('pointer-events','none');

    // Invisible drag targets covering each column
    gF.selectAll('.dt').data(d3.range(nH)).enter()
      .append('rect')
      .attr('x', i=>xF(i)-3).attr('width', xF.bandwidth()+6)
      .attr('y',0).attr('height',fph)
      .attr('fill','transparent').attr('cursor','ns-resize')
      .call(d3.drag()
        .container(gF.node())
        .on('start drag', function(event, d) {
            if(event.sourceEvent) event.sourceEvent.stopPropagation();
            amps[d] = Math.max(-1.5, Math.min(1.5, yF.invert(event.y)));
            update();
        })
      );

    function update() {
        const z = yF(0);
        // Update user bars
        bars.each(function(d) {
            const top = yF(amps[d]);
            d3.select(this).attr('y', Math.min(z,top))
              .attr('height', Math.max(0.5, Math.abs(top-z)));
        });
        // Update handles
        handles.each(function(d) { d3.select(this).attr('cy', yF(amps[d])); });
        // Update target outlines
        const fn = refs[curRef];
        refBars.each(function(d) {
            const a = fn(d+1);
            if(Math.abs(a)<0.001){ d3.select(this).attr('height',0); return; }
            const top = yF(a);
            d3.select(this).attr('y', Math.min(z,top)).attr('height', Math.abs(top-z));
        });
        // Update time domain curves
        const ad=[], rd=[];
        for(let t=0; t<=4*Math.PI; t+=0.02){
            let av=0, rv=0;
            for(let i=0;i<nH;i++){ const k=i+1; av+=amps[i]*Math.sin(k*t); rv+=fn(k)*Math.sin(k*t); }
            ad.push({t, v:av}); rd.push({t, v:rv});
        }
        refPath.attr('d', lineFn(rd));
        approxPath.attr('d', lineFn(ad));
    }

    // Reference signal buttons
    document.querySelectorAll('.ref-btn').forEach(btn => {
        btn.addEventListener('click', function(){
            curRef = this.dataset.ref;
            document.querySelectorAll('.ref-btn').forEach(b => {
                b.style.opacity = b===this ? '1' : '0.5';
                b.style.borderColor = b===this ? '#61afef' : '#555';
                b.style.background = b===this ? 'rgba(97,175,239,0.15)' : 'rgba(255,255,255,0.08)';
            });
            update();
        });
    });
    document.getElementById('fourier-reset')?.addEventListener('click', () => {
        amps.fill(0); update();
    });
    document.getElementById('fourier-reveal')?.addEventListener('click', () => {
        const fn = refs[curRef];
        for(let i=0;i<nH;i++) amps[i] = fn(i+1);
        update();
    });

    update();
}

function initAR2Plot() {
    const container = d3.select('#ar2-plot');
    container.selectAll('*').remove();

    const width = 750, height = 230;
    const margin = {top: 15, right: 20, bottom: 25, left: 40};

    const svg = container.append('svg').attr('width', width).attr('height', height);
    const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

    const x = d3.scaleLinear().domain([0, 100]).range([0, width - margin.left - margin.right]);
    const y = d3.scaleLinear().domain([-1.5, 1.5]).range([height - margin.top - margin.bottom, 0]);

    g.append('line').attr('x1', 0).attr('x2', width - margin.left - margin.right)
     .attr('y1', y(0)).attr('y2', y(0)).attr('stroke', '#444').attr('stroke-width', 1);

    g.append('g').attr('class', 'axis').attr('transform', `translate(0,${height - margin.top - margin.bottom})`)
     .call(d3.axisBottom(x).ticks(10));
    g.append('g').attr('class', 'axis').call(d3.axisLeft(y).ticks(5));

    const line = d3.line().x(d => x(d.i)).y(d => y(d.v));
    const truePath = g.append('path').attr('fill', 'none').attr('stroke', '#61afef').attr('stroke-width', 2);
    const predPath = g.append('path').attr('fill', 'none').attr('stroke', '#e06c75').attr('stroke-width', 2).attr('stroke-dasharray', '6,3');

    function update() {
        const omega = +document.getElementById('omega').value;
        document.getElementById('omega-val').textContent = omega.toFixed(2);

        const N = 100;
        const trueData = [], predData = [];
        const xTrue = [];

        for (let i = 0; i < N; i++) {
            xTrue.push(Math.sin(omega * i));
            trueData.push({i, v: xTrue[i]});
        }

        const w1 = 2 * Math.cos(omega);
        const w2 = -1;

        const xPred = [xTrue[0], xTrue[1]];
        for (let i = 2; i < N; i++) {
            xPred.push(w1 * xPred[i-1] + w2 * xPred[i-2]);
        }
        for (let i = 0; i < N; i++) {
            predData.push({i, v: xPred[i]});
        }

        truePath.attr('d', line(trueData));
        predPath.attr('d', line(predData));

        document.getElementById('ar2-params').innerHTML =
            `w₁ = ${w1.toFixed(3)}, w₂ = ${w2.toFixed(3)}, ω = ${omega.toFixed(2)}`;
    }

    document.getElementById('omega').oninput = update;
    update();
}

// Initialize first visible plots
setTimeout(() => {
    if (document.getElementById('fourier-plot')) initFourierPlot();
}, 500);
</script>
</body>
</html>
